/*! jQuery Selective - v0.1.0 - 2013-08-30
* https://github.com/amazingSurge/jquery-selective
* Copyright (c) 2013 amazingSurge; Licensed GPL */
(function(t,e,i,s){"use strict";var n=i.Selective=function(t,e){this.el=t,this.$el=i(t).css({display:"none"})||i("<select></select>"),this.options=i.extend(!0,{},n.defaults,e),this.namespace=this.options.namespace;var s=this,o=i(this.options.tpl.frame.call(this)),l=function(){return s.$el.html(s.options.tpl.select.call(s)),s.$el.children("select")};this.$select=this.$el.is("select")===!0?this.$el:l(),this.$el.after(o),this._init(),this.opened=!1};n.defaults={namespace:"selective",buildFromHtml:!0,closeOnSelect:!1,local:null,selected:null,withSearch:!1,searchType:null,ajax:{work:!1,url:null,quietMills:null,loadMore:!1,pageSize:null},tpl:{frame:function(){return'<div class="'+this.namespace+'">'+'<div class="'+this.namespace+'-trigger">'+this.options.tpl.triggerButton.call(this)+'<div class="'+this.namespace+'-trigger-dropdown">'+'<div class="'+this.namespace+'-list-wrap">'+this.options.tpl.list.call(this)+"</div>"+"</div>"+"</div>"+this.options.tpl.items.call(this)+"</div>"},search:function(){return'<input class="'+this.namespace+'-search" type="text" placeholder="Search...">'},select:function(){return'<select class="'+this.namespace+'-select" name="'+this.namespace+'" multiple="multiple"></select>'},optionValue:function(t){return t.name},option:function(t){return'<option value="'+this.options.tpl.optionValue.call(this)+'">'+t+"</option>"},items:function(){return'<ul class="'+this.namespace+'-items"></ul>'},item:function(t){return'<li class="'+this.namespace+'-item">'+t+this.options.tpl.itemRemove.call(this)+"</li>"},itemRemove:function(){return'<span class="'+this.namespace+'-remove">x</span>'},triggerButton:function(){return'<div class="'+this.namespace+'-trigger-button">Add</div>'},list:function(){return'<ul class="'+this.namespace+'-list"></ul>'},listItem:function(t){return'<li class="'+this.namespace+'-list-item">'+t+"</li>"}},query:function(){},beforeShow:function(){},afterShow:function(){},beforeHide:function(){},afterHide:function(){},beforeSearch:function(){},afterSearch:function(){},beforeSelected:function(){},afterSelected:function(){},beforeUnselect:function(){},afterUnselect:function(){},beforeItemRemove:function(){},afterItemRemove:function(){},beforeItemAdd:function(){},afterItemAdd:function(){}},n.prototype={constructor:n,_list:{build:function(t,e){var n=i("<ul></ul>"),o=t._options.getOptions(t);return t.options.buildFromHtml===!0?0!==o.length&&i.each(o,function(e,o){var l=i(t.options.tpl.listItem.call(t,o.text)),c=i(o);t.setIndex(l,c),c.attr("selected")!==s&&t.select(l),n.append(l)}):null!==e&&(i.each(e,function(s){var o=i(t.options.tpl.listItem.call(t,e[s]));t.setIndex(o,e[s]),n.append(o)}),0!==o.length&&i.each(o,function(e,o){var l=i(o),c=t.getItem("li",n,t.options.tpl.optionValue(l.data("selective_index")));c!==s&&t._list.select(t,c)})),t.$list.append(n.children("li")),t},buildSearch:function(t){return t.options.withSearch===!0&&(t.$triggerDropdown.prepend(t.options.tpl.search.call(t)),t.$search=t.$triggerDropdown.find("."+t.namespace+"-search")),t},select:function(t,e){return t.options.beforeSelected(),e.addClass(t.namespace+"-selected"),t.options.afterSelected(),t},unselect:function(t,e){return t.options.beforeUnselected(),e.removeClass(t.namespace+"-selected"),t.options.afterUnselected(),t},click:function(t){t.$list.on("click","li",function(){var e=i(this);e.hasClass(t.namespace+"-selected")||t.select(e)})},filter:function(t,e){return i.expr[":"].Contains=function(t,e,i){return jQuery(t).text().toUpperCase().indexOf(i[3].toUpperCase())>=0},e?(t.$list.find("li:not(:Contains("+e+"))").slideUp(),t.$list.find("li:Contains("+e+")").slideDown()):t.$list.children("li").slideDown(),t},loadMore:function(t,e){var i=e||9999;return i>t.page&&t.$listWrap.on("scroll.selective",function(){var e=t.$list.outerHeight(),i=t.$listWrap.height(),s=t.$listWrap.scrollTop(),n=e-i-s;0===n&&t.options.query(t,t.$search.val(),++t.page)}),t},loadMoreRemove:function(t){return t.$listWrap.off("scroll.selective"),t}},_options:{getOptions:function(t){return t.$options=t.$select.find("option"),t.$options},select:function(t,e){return e.prop("selected",!0),t},unselect:function(t,e){return e.prop("selected",!1),t},add:function(t,e){if(t.options.buildFromHtml===!1&&t.getItem("option",t.$select,t.options.tpl.optionValue(e))===s){var n=i(t.options.tpl.option.call(t,e));return t.setIndex(n,e),t.$select.append(n),n}},remove:function(t,e){return e.remove(),t}},_trigger:{show:function(t){return i(e).on("click.selective",function(e){t.options.closeOnSelect===!0?0===i(e.target).closest(t.$triggerButton).length&&0===i(e.target).closest(t.$search).length&&t._trigger.hide(t):0===i(e.target).closest(t.$trigger).length&&t._trigger.hide(t)}),t.$trigger.addClass(t.namespace+"-active"),t.opened=!0,t.options.ajax.loadMore===!0&&t._list.loadMore(t),t},hide:function(t){return i(e).off("click.selective"),t.$trigger.removeClass(t.namespace+"-active"),t.opened=!1,t.options.ajax.loadMore===!0&&t._list.loadMoreRemove(t),t},click:function(t){t.$triggerButton.on("click",function(){t.opened===!1?t.show(t):t.opened===!0&&t.hide(t)})}},_items:{withDefaults:function(t,e){null!==e&&i.each(e,function(i){t._options.add(t,e[i]),t._options.select(t,t.getItem("option",t.$select,t.options.tpl.optionValue(e[i]))),t._items.add(t,e[i])})},add:function(t,e,s){t.options.beforeItemAdd();var n,o;return o=t.options.buildFromHtml===!0?s:e,n=i(t.options.tpl.item.call(t,o)),t.setIndex(n,e),t.$items.append(n),t.options.afterItemAdd(),n},remove:function(t,e){var i,n;return t.options.buildFromHtml===!0?(t._list.unselect(t,e.data("selective_index")),t._options.unselect(t,e.data("selective_index").data("selective_index"))):(i=t.getItem("li",t.$list,t.options.tpl.optionValue(e.data("selective_index"))),i!==s&&t._list.unselect(t,i),n=t.getItem("option",t.$select,t.options.tpl.optionValue(e.data("selective_index"))),t._options.unselect(t,n)._options.remove(t,n)),e.remove(),t},click:function(t){t.$items.on("click","."+t.namespace+"-remove",function(){var e=i(this),s=e.parents("li");t.itemRemove(s)})}},_search:{change:function(t){t.$search.change(function(){t.options.beforeSearch(),t.options.buildFromHtml===!0?t._list.filter(t,t.$search.val()):""!==t.$search.val()?(t.page=1,t.options.query(t,t.$search.val(),t.page)):t.update(t.options.local),t.options.afterSearch()})},keyup:function(e){var i,s=e.options.ajax.quietMills||1e3,n="",o="";e.$search.on("keyup",function(l){e.options.beforeSearch(),o=e.$search.val(),e.options.buildFromHtml===!0?o!==n&&e._list.filter(e,o):(o!==n||13===l.keyCode)&&(t.clearTimeout(i),i=t.setTimeout(function(){""!==o?(e.page=1,e.options.query(e,o,e.page)):e.update(e.options.local)},s)),n=o,e.options.afterSearch()})},bind:function(t,e){"change"===e?this.change(t):"keyup"===e&&this.keyup(t)}},_init:function(){this.$selective=this.$el.next("."+this.namespace),this.$items=this.$selective.find("."+this.namespace+"-items"),this.$trigger=this.$selective.find("."+this.namespace+"-trigger"),this.$triggerButton=this.$selective.find("."+this.namespace+"-trigger-button"),this.$triggerDropdown=this.$selective.find("."+this.namespace+"-trigger-dropdown"),this.$listWrap=this.$selective.find("."+this.namespace+"-list-wrap"),this.$list=this.$selective.find("."+this.namespace+"-list"),this._items.withDefaults(this,this.options.selected),this.update(this.options.local)._list.buildSearch(this),this._trigger.click(this),this._list.click(this),this._items.click(this),this.options.withSearch===!0&&this._search.bind(this,this.options.searchType)},show:function(){return this.options.beforeShow(),this._trigger.show(this),this.options.afterShow(),this},hide:function(){return this.options.beforeHide(),this._trigger.hide(this),this.options.afterHide(),this},select:function(t){this._list.select(this,t);var e=t.data("selective_index");return this.options.buildFromHtml===!0?(this._options.select(this,e),this._items.add(this,t,e.text())):(this._options.add(this,e),this._options.select(this,this.getItem("option",this.$select,this.options.tpl.optionValue(e))),this._items.add(this,e)),this},unselect:function(t){return this._list.unselect(this,t),this},setIndex:function(t,e){return t.data("selective_index",e),this},getItem:function(t,e,i){for(var n=e.children(t),o="",l=0;n.length>l;l++)this.options.tpl.optionValue(n.eq(l).data("selective_index"))===i&&(o=l);return""===o?s:n.eq(o)},itemAdd:function(t,e){return this._items.add(this,t,e),this},itemRemove:function(t){return this.options.beforeItemRemove(),this._items.remove(this,t),this.options.afterItemRemove(),this},optionAdd:function(t){return this._options.add(this,t),this},optionRemove:function(t){return this._options.remove(this,t),this},update:function(t){return this.$list.empty(),this.page=1,null!==t?this._list.build(this,t):this._list.build(this),this}},i.fn.selective=function(t){if("string"==typeof t){var e=t,o=arguments.length>1?Array.prototype.slice.call(arguments,1):s;return this.each(function(){var t=i.data(this,"selective");"function"==typeof t[e]&&t[e].apply(t,o)})}return this.each(function(){i.data(this,"selective")||i.data(this,"selective",new n(this,t))})}})(window,document,jQuery);